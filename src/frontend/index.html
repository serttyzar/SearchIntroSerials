<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8" />
    <title>üé¨ –î–µ—Ç–µ–∫—Ç–æ—Ä –∑–∞—Å—Ç–∞–≤–æ–∫</title>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <style>
        body {
            font-family: sans-serif;
            max-width: 600px;
            margin: auto;
            padding: 30px;
            text-align: center;
        }
        input, button {
            width: 100%;
            margin: 10px 0;
            display: block;
        }
        #progressBar {
            width: 100%;
            background-color: #f1f1f1;
            border-radius: 5px;
            overflow: hidden;
            margin-top: 20px;
        }
        #bar {
            height: 30px;
            width: 0%;
            background-color: #4caf50;
            text-align: center;
            line-height: 30px;
            color: white;
            transition: width 0.3s ease-in-out;
        }
        #stepMessage {
            margin-top: 10px;
            font-size: 1em;
            color: #555;
        }
        #loading {
            margin-top: 10px;
            font-size: 1em;
            color: #888;
            display: none;
        }
        #result {
            margin-top: 20px;
            font-size: 1.2em;
        }
    </style>
</head>
<body>
    <h1>üé¨ –î–µ—Ç–µ–∫—Ç–æ—Ä –∑–∞—Å—Ç–∞–≤–æ–∫ –≤ —Å–µ—Ä–∏–∞–ª–µ</h1>
    <form id="uploadForm">
        <input type="file" name="video" accept="video/*" required />
        <button type="submit">üöÄ –ù–∞–π—Ç–∏ –∑–∞—Å—Ç–∞–≤–∫—É</button>
    </form>

    <div id="progressBar">
        <div id="bar">0%</div>
    </div>

    <div id="stepMessage"></div>
    <div id="loading">‚è≥ –û–±—Ä–∞–±–æ—Ç–∫–∞... –≠—Ç–æ –º–æ–∂–µ—Ç –∑–∞–Ω—è—Ç—å –Ω–µ–∫–æ—Ç–æ—Ä–æ–µ –≤—Ä–µ–º—è</div>
    <div id="result"></div>

    <script>
        const form = document.getElementById("uploadForm");
        const progressBar = document.getElementById("bar");
        const resultDiv = document.getElementById("result");
        const loadingDiv = document.getElementById("loading");
        const stepMessageDiv = document.getElementById("stepMessage");

        let currentUid = null;

        form.addEventListener("submit", async function (e) {
            e.preventDefault();
            resultDiv.innerHTML = "";
            progressBar.style.width = "0%";
            progressBar.textContent = "0%";
            stepMessageDiv.textContent = "";
            loadingDiv.style.display = "block";

            const formData = new FormData(form);
            const response = await fetch("/detect-intro", {
                method: "POST",
                body: formData
            });

            const data = await response.json();
            currentUid = data.uid;
        });

        const socket = io();

        socket.on("progress_update", function (data) {
            if (data.uid === currentUid) {
                loadingDiv.style.display = "none";

                const percent = data.progress;
                progressBar.style.width = percent + "%";
                progressBar.textContent = percent + "%";

                // –û–±–Ω–æ–≤–∏–º —Ç–µ–∫—Å—Ç —Ç–µ–∫—É—â–µ–≥–æ —à–∞–≥–∞
                stepMessageDiv.textContent = data.message;
            }
        });

        socket.on("result", function (data) {
            if (data.uid === currentUid) {
                loadingDiv.style.display = "none";
                stepMessageDiv.textContent = "";  // —É–±–µ—Ä–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ —à–∞–≥–∞—Ö

                if (data.error) {
                    resultDiv.textContent = "‚ùå –û—à–∏–±–∫–∞: " + data.error;
                } else if (data.intro) {
                    const [start, end] = data.intro;
                    resultDiv.innerHTML = `‚úÖ –ó–∞—Å—Ç–∞–≤–∫–∞: <b>${start.toFixed(1)}—Å</b> ‚Äì <b>${end.toFixed(1)}—Å</b>`;
                } else {
                    resultDiv.textContent = "‚ùå –ó–∞—Å—Ç–∞–≤–∫–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.";
                }
            }
        });

        socket.on("connect_error", function (err) {
            loadingDiv.style.display = "none";
            resultDiv.textContent = "‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º.";
        });
    </script>
</body>
</html>
